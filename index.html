<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maidle 游戏</title>
    <script>
        let musicInfo = {};
        let alias = {};
        let targetMusic = null;
        let isPlaying = false;
        let guesses = [];
        let hintsList = [];
        let guessedIds = [];

        async function loadGameData() {
            const [musicResponse, aliasResponse] = await Promise.all([
                fetch("static/music_info.json"),
                fetch("static/alias.json")
            ]);
            musicInfo = await musicResponse.json();
            alias = await aliasResponse.json();
        }

        function startGame() {
            if (isPlaying) {
                alert("游戏正在进行中，请先结束游戏！");
                return;
            }

            const range = document.getElementById("difficulty-range").value;
            const keys = Object.keys(musicInfo).filter(key => {
                const music = musicInfo[key];
                if (range === "13") {
                    return music.masds >= 13;
                } else if (range === "13+") {
                    return music.masds >= 13.7; // 假设 13+ 表示 13.7 及以上
                } else if (range === "14") {
                    return music.masds >= 14;
                } else if (range === "14+") {
                    return music.masds >= 14.7; // 假设 14+ 表示 14.7 及以上
                }
                return true; // 无限制
            });

            if (keys.length === 0) {
                alert("没有符合条件的曲目，请选择其他范围！");
                return;
            }

            const randomIndex = Math.floor(Math.random() * keys.length);
            targetMusic = musicInfo[keys[randomIndex]];
            isPlaying = true;
            guesses = [];
            hintsList = [];
            guessedIds = [];
            document.getElementById("message").innerText = "游戏开始！你一共有十次机会猜曲目。";
            document.getElementById("hints-container").innerHTML = "";
        }

        function getHint(target, guess) {
            const versionToId = {
                "maimai": 1, "maimai PLUS": 2, "maimai GreeN": 3, "maimai GreeN PLUS": 4,
                "maimai ORANGE": 5, "maimai ORANGE PLUS": 6, "maimai PiNK": 7, "maimai PiNK PLUS": 8,
                "maimai MURASAKi": 9, "maimai MURASAKi PLUS": 10, "maimai MiLK": 11, "MiLK PLUS": 12,
                "maimai FiNALE": 13, "舞萌DX": 14, "舞萌DX2021": 15, "舞萌DX2022": 16,
                "舞萌DX2023": 17, "舞萌DX2024": 18
            };
            const hints = [];
            hints.push(`ID: ${target.id === guess.id ? "√ " : ""}${guess.id}`);
            hints.push(`标题: ${target.title === guess.title ? "√ " : ""}${guess.title}`);
            hints.push(`类型: ${target.type === guess.type ? "√ " : ""}${guess.type}`);
            hints.push(`艺术家: ${target.artist === guess.artist ? "√ " : ""}${guess.artist}`);
            hints.push(`流派: ${target.genre === guess.genre ? "√ " : ""}${guess.genre}`);
            hints.push(`版本: ${target.version === guess.version ? "√ " : versionToId[target.version] > versionToId[guess.version] ? "→ 早了 " : "← 晚了 "}${guess.version}`);
            hints.push(`BPM: ${target.bpm === guess.bpm ? "√ " : target.bpm > guess.bpm ? "↑ 低了 " : "↓ 高了 "}${guess.bpm}`);

            // 红谱定数提示
            let expflag = 0;
            if (target.explevel === guess.explevel) {
                expflag = 1;
            }
            if (target.expds === guess.expds) {
                hints.push(`红谱定数: √ ${guess.expds}`);
            } else if (target.expds > guess.expds) {
                if (expflag === 1) {
                    hints.push(`红谱定数: ↑ ↕低了 ${guess.expds}`);
                } else {
                    hints.push(`红谱定数: ↑ 低了 ${guess.expds}`);
                }
            } else {
                if (expflag === 1) {
                    hints.push(`红谱定数: ↓ ↕高了 ${guess.expds}`);
                } else {
                    hints.push(`红谱定数: ↓ 高了 ${guess.expds}`);
                }
            }

            // 紫谱定数提示
            let lvflag = 0;
            if (target.maslevel === guess.maslevel) {
                lvflag = 1;
            }
            if (target.masds === guess.masds) {
                hints.push(`紫谱定数: √ ${guess.masds}`);
            } else if (target.masds > guess.masds) {
                if (lvflag === 1) {
                    hints.push(`紫谱定数: ↑ ↕低了 ${guess.masds}`);
                } else {
                    hints.push(`紫谱定数: ↑ 低了 ${guess.masds}`);
                }
            } else {
                if (lvflag === 1) {
                    hints.push(`紫谱定数: ↓ ↕高了 ${guess.masds}`);
                } else {
                    hints.push(`紫谱定数: ↓ 高了 ${guess.masds}`);
                }
            }

            // 紫谱谱师提示
            if (target.mascharter === guess.mascharter) {
                hints.push(`紫谱谱师: √ ${guess.mascharter}`);
            } else {
                hints.push(`紫谱谱师: ${guess.mascharter}`);
            }

            // 紫谱绝赞数量提示
            if (target.masbreak === guess.masbreak) {
                hints.push(`紫谱绝赞数量: √ ${guess.masbreak}`);
            } else if (target.masbreak > guess.masbreak) {
                hints.push(`紫谱绝赞数量: ↑ 少了 ${guess.masbreak}`);
            } else {
                hints.push(`紫谱绝赞数量: ↓ 多了 ${guess.masbreak}`);
            }

            return hints;
        }

        function submitGuess() {
            if (!isPlaying) {
                document.getElementById("message").innerText = "游戏未开始，请先开始游戏！";
                return;
            }
            let guessId = document.getElementById("guess-id").value.trim();
            if (!guessId) {
                document.getElementById("message").innerText = "请输入曲目 ID 或别名。";
                return;
            }

            let guessData = musicInfo[guessId];
            if (!guessData) {
                if (alias[guessId]) {
                    if (alias[guessId].length > 1) {
                        const matches = alias[guessId]
                            .map(item => `ID: ${item.id}, 标题: ${item.name}`)
                            .join("<br>");
                        document.getElementById("message").innerHTML = `别名有多个匹配，请输入具体的曲目 ID：<br>${matches}`;
                        return;
                    } else {
                        guessId = alias[guessId][0].id;
                        guessData = musicInfo[guessId];
                        if (!guessData) {
                            document.getElementById("message").innerText = "曲目不存在，请重新输入。";
                            return;
                        }
                    }
                } else {
                    document.getElementById("message").innerText = "曲目不存在，请重新输入。";
                    return;
                }
            }

            if (guessedIds.includes(guessId)) {
                document.getElementById("message").innerText = "你已经猜过这个曲目了，请重新输入。";
                return;
            }

            guessedIds.push(guessId);
            guesses.push(`ID: ${guessId}, 标题: ${guessData.title}`);
            const hints = getHint(targetMusic, guessData);
            hintsList.push(hints);

            // 清空输入框
            document.getElementById("guess-id").value = "";

            if (targetMusic.title === guessData.title) {
                isPlaying = false;
                document.getElementById("message").innerText = "🎉 恭喜你，猜对了！🎉";
                renderHints();
                return;
            }

            if (guesses.length >= 10) {
                isPlaying = false;
                document.getElementById("message").innerText = `你已经猜错10次，游戏结束！正确答案是 ${targetMusic.id}：${targetMusic.title}`;
                renderHints();
                return;
            }

            document.getElementById("message").innerText = "继续猜测！";
            renderHints();
        }

        function quitGame() {
            if (!isPlaying) {
                document.getElementById("message").innerText = "当前没有正在进行的游戏。";
                return;
            }
            isPlaying = false;
            document.getElementById("message").innerText = `游戏结束，正确答案是 ${targetMusic.id}：${targetMusic.title}`;
        }

        function renderHints() {
            const hintsContainer = document.getElementById("hints-container");
            hintsContainer.innerHTML = "";
            hintsList.forEach((hintSet, index) => {
                const guessBlock = document.createElement("div");
                guessBlock.innerHTML = `<strong>猜测 ${index + 1}:</strong>`;
                hintSet.forEach(hint => {
                    const hintLine = document.createElement("p");
                    hintLine.style.color = hint.includes("√") ? "green" : hint.includes("↕") ? "orange" : "grey";
                    hintLine.textContent = hint.replace("√", "").replace("↕", "");
                    guessBlock.appendChild(hintLine);
                });
                hintsContainer.appendChild(guessBlock);
            });
        }

        window.onload = async () => {
            await loadGameData();
            document.getElementById("start-game").addEventListener("click", startGame);
            document.getElementById("submit-guess").addEventListener("click", submitGuess);
            document.getElementById("quit-game").addEventListener("click", quitGame);
        };
    </script>
</head>
<body>
    <h1>Maidle 游戏</h1>
    <p>made by 宇航员Dale</p>
    <div id="hints-container" style="margin-top: 20px; font-size: 16px; line-height: 0.7;"></div>
    <div>
        <input type="text" id="guess-id" placeholder="输入曲目id或别名" style="font-size: 18px; padding: 10px; width: 60%;">
    </div>
    <div>
        <label for="difficulty-range" style="font-size: 18px;">选择出题范围：</label>
        <select id="difficulty-range" style="font-size: 18px; padding: 5px;">
            <option value="unlimited">无限制</option>
            <option value="13">紫谱定数13及以上</option>
            <option value="13+">紫谱定数13+及以上</option>
            <option value="14">紫谱定数14及以上</option>
            <option value="14+">紫谱定数14+及以上</option>
        </select>
    </div>
    <div>
        <p>提示：可以输入曲目id或别名。绿色代表正确，定数黄色代表等级正确。</p>
    </div>
    <div>
        <button id="start-game" style="font-size: 18px; padding: 10px 20px;">开始游戏</button>
        <button id="submit-guess" style="font-size: 18px; padding: 10px 20px;">提交猜测</button>
        <button id="quit-game" style="font-size: 18px; padding: 10px 20px;">不玩了</button>
    </div>
    <p id="message"></p>
    <p>本站总访问量：<span id="busuanzi_value_site_pv"></span> 次</p>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</body>
</html>