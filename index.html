<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maidle æ¸¸æˆ</title>
    <script>
        let musicInfo = {};
        let alias = {};
        let music_alias = {};
        let targetMusic = null;
        let isPlaying = false;
        let guesses = [];
        let hintsList = [];
        let guessedIds = [];

        async function loadGameData() {
            const loadingDiv = document.getElementById("loading");
            const progressBar = document.getElementById("progress-bar");
            const progressText = document.getElementById("progress-text");

            // æ¨¡æ‹ŸåŠ è½½æ•°æ®çš„åˆ†æ­¥è¿›åº¦
            const steps = [
                { task: "åŠ è½½éŸ³ä¹ä¿¡æ¯", fetch: fetch("static/music_info.json") },
                { task: "åŠ è½½åˆ«åä¿¡æ¯", fetch: fetch("static/alias.json") },
                { task: "åŠ è½½å…¶ä»–æ•°æ®", fetch: fetch("static/all_alias.json") } // å‡è®¾æœ‰å…¶ä»–æ•°æ®éœ€è¦åŠ è½½
            ];

            let progress = 0;
            const stepIncrement = 100 / steps.length;

            for (const step of steps) {
                try {
                    const response = await step.fetch;
                    if (step.task === "åŠ è½½éŸ³ä¹ä¿¡æ¯") {
                        musicInfo = await response.json();
                    } else if (step.task === "åŠ è½½åˆ«åä¿¡æ¯") {
                        alias = await response.json();
                    } else if (step.task === "åŠ è½½å…¶ä»–æ•°æ®") {
                        music_alias = await response.json();
                    }
                    progress += stepIncrement;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${Math.round(progress)}%`;
                } catch (error) {
                    console.error(`${step.task}å¤±è´¥:`, error);
                    loadingDiv.textContent = `${step.task}å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼`;
                    throw error;
                }
            }
            document.getElementById("loading").style.display = "none";
            document.getElementById("game-container").style.display = "block";
        }

        function startGame() {
            if (isPlaying) {
                alert("æ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å…ˆç»“æŸæ¸¸æˆï¼");
                return;
            }

            const range = document.getElementById("difficulty-range").value;
            const keys = Object.keys(musicInfo).filter(key => {
                const music = musicInfo[key];
                if (range === "13") {
                    return music.masds >= 13;
                } else if (range === "13+") {
                    return music.masds >= 13.7; // å‡è®¾ 13+ è¡¨ç¤º 13.7 åŠä»¥ä¸Š
                } else if (range === "14") {
                    return music.masds >= 14;
                } else if (range === "14+") {
                    return music.masds >= 14.7; // å‡è®¾ 14+ è¡¨ç¤º 14.7 åŠä»¥ä¸Š
                }
                return true; // æ— é™åˆ¶
            });

            if (keys.length === 0) {
                alert("æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ›²ç›®ï¼Œè¯·é€‰æ‹©å…¶ä»–èŒƒå›´ï¼");
                return;
            }

            const randomIndex = Math.floor(Math.random() * keys.length);
            targetMusic = musicInfo[keys[randomIndex]];
            isPlaying = true;
            guesses = [];
            hintsList = [];
            guessedIds = [];
            document.getElementById("message").innerText = "æ¸¸æˆå¼€å§‹ï¼ä½ ä¸€å…±æœ‰åæ¬¡æœºä¼šçŒœæ›²ç›®ã€‚";
            document.getElementById("hints-container").innerHTML = "";
        }
        function searchMatches() {
            console.log("å½“å‰ music_alias:", music_alias); // æ£€æŸ¥æ˜¯å¦ä¸ºç©º
            const input = document.getElementById("guess-id").value.trim().toLowerCase();
            const resultsContainer = document.getElementById("search-results");
            resultsContainer.innerHTML = ""; // æ¸…ç©ºä¹‹å‰çš„æœç´¢ç»“æœ

            if (!input) {
                resultsContainer.style.display = "none";
                return;
            }

            const matches = Object.keys(musicInfo)
                .filter(key => {
                    const music = musicInfo[key];
                    const musicAlias = music_alias[key];
                    return (
                        key.toLowerCase().includes(input) || 
                        music.title.toLowerCase().includes(input) || 
                        (musicAlias && musicAlias.some(alias => alias.name && alias.name.toLowerCase().includes(input)))
                    );
                })
                .map(key => {
                    const music = musicInfo[key];
                    return `<div style="padding: 5px; cursor: pointer;" onclick="selectMatch('${key}')">${music.title} (ID: ${key})</div>`;
                });

            if (matches.length > 0) {
                resultsContainer.innerHTML = matches.join("");
                resultsContainer.style.display = "block";
            } else {
                resultsContainer.style.display = "none";
            }
        }

        function selectMatch(id) {
            document.getElementById("guess-id").value = id;
            document.getElementById("search-results").style.display = "none";
        }
        function getHint(target, guess) {
            const versionToId = {
                "maimai": 1, "maimai PLUS": 2, "maimai GreeN": 3, "maimai GreeN PLUS": 4,
                "maimai ORANGE": 5, "maimai ORANGE PLUS": 6, "maimai PiNK": 7, "maimai PiNK PLUS": 8,
                "maimai MURASAKi": 9, "maimai MURASAKi PLUS": 10, "maimai MiLK": 11, "MiLK PLUS": 12,
                "maimai FiNALE": 13, "èˆèŒDX": 14, "èˆèŒDX2021": 15, "èˆèŒDX2022": 16,
                "èˆèŒDX2023": 17, "èˆèŒDX2024": 18
            };
            const hints = [];
            hints.push(`ID: ${target.id === guess.id ? "âˆš " : ""}${guess.id}`);
            hints.push(`ç±»å‹: ${target.type === guess.type ? "âˆš " : ""}${guess.type}`);
            hints.push(`æ ‡é¢˜: ${target.title === guess.title ? "âˆš " : ""}${guess.title}`);
            hints.push(`è‰ºæœ¯å®¶: ${target.artist === guess.artist ? "âˆš " : ""}${guess.artist}`);
            hints.push(`æµæ´¾: ${target.genre === guess.genre ? "âˆš " : ""}${guess.genre}`);
            hints.push(`ç‰ˆæœ¬: ${target.version === guess.version ? "âˆš " : versionToId[target.version] > versionToId[guess.version] ? "â†’ æ—©äº† " : "â† æ™šäº† "}${guess.version}`);
            hints.push(`BPM: ${target.bpm === guess.bpm ? "âˆš " : target.bpm > guess.bpm ? "â†‘ ä½äº† " : "â†“ é«˜äº† "}${guess.bpm}`);

            // çº¢è°±å®šæ•°æç¤º
            let expflag = 0;
            if (target.explevel === guess.explevel) {
                expflag = 1;
            }
            if (target.expds === guess.expds) {
                hints.push(`çº¢è°±å®šæ•°: âˆš ${guess.expds}`);
            } else if (target.expds > guess.expds) {
                if (expflag === 1) {
                    hints.push(`çº¢è°±å®šæ•°: â†‘ â†•ä½äº† ${guess.expds}`);
                } else {
                    hints.push(`çº¢è°±å®šæ•°: â†‘ ä½äº† ${guess.expds}`);
                }
            } else {
                if (expflag === 1) {
                    hints.push(`çº¢è°±å®šæ•°: â†“ â†•é«˜äº† ${guess.expds}`);
                } else {
                    hints.push(`çº¢è°±å®šæ•°: â†“ é«˜äº† ${guess.expds}`);
                }
            }

            // ç´«è°±å®šæ•°æç¤º
            let lvflag = 0;
            if (target.maslevel === guess.maslevel) {
                lvflag = 1;
            }
            if (target.masds === guess.masds) {
                hints.push(`ç´«è°±å®šæ•°: âˆš ${guess.masds}`);
            } else if (target.masds > guess.masds) {
                if (lvflag === 1) {
                    hints.push(`ç´«è°±å®šæ•°: â†‘ â†•ä½äº† ${guess.masds}`);
                } else {
                    hints.push(`ç´«è°±å®šæ•°: â†‘ ä½äº† ${guess.masds}`);
                }
            } else {
                if (lvflag === 1) {
                    hints.push(`ç´«è°±å®šæ•°: â†“ â†•é«˜äº† ${guess.masds}`);
                } else {
                    hints.push(`ç´«è°±å®šæ•°: â†“ é«˜äº† ${guess.masds}`);
                }
            }

            // ç´«è°±è°±å¸ˆæç¤º
            if (target.mascharter === guess.mascharter) {
                hints.push(`ç´«è°±è°±å¸ˆ: âˆš ${guess.mascharter}`);
            } else {
                hints.push(`ç´«è°±è°±å¸ˆ: ${guess.mascharter}`);
            }

            // ç´«è°±ç»èµæ•°é‡æç¤º
            if (target.masbreak === guess.masbreak) {
                hints.push(`ç´«è°±ç»èµæ•°é‡: âˆš ${guess.masbreak}`);
            } else if (target.masbreak > guess.masbreak) {
                hints.push(`ç´«è°±ç»èµæ•°é‡: â†‘ å°‘äº† ${guess.masbreak}`);
            } else {
                hints.push(`ç´«è°±ç»èµæ•°é‡: â†“ å¤šäº† ${guess.masbreak}`);
            }

            return hints;
        }

        function submitGuess() {
            if (!isPlaying) {
                document.getElementById("message").innerText = "æ¸¸æˆæœªå¼€å§‹ï¼Œè¯·å…ˆå¼€å§‹æ¸¸æˆï¼";
                return;
            }
            let guessId = document.getElementById("guess-id").value.trim();
            if (!guessId) {
                document.getElementById("message").innerText = "è¯·è¾“å…¥æ›²ç›® ID æˆ–åˆ«åã€‚";
                return;
            }

            let guessData = musicInfo[guessId];
            if (!guessData) {
                if (alias[guessId]) {
                    if (alias[guessId].length > 1) {
                        const matches = alias[guessId]
                            .map(item => `ID: ${item.id}, æ ‡é¢˜: ${item.name}`)
                            .join("<br>");
                        document.getElementById("message").innerHTML = `åˆ«åæœ‰å¤šä¸ªåŒ¹é…ï¼Œè¯·è¾“å…¥å…·ä½“çš„æ›²ç›® IDï¼š<br>${matches}`;
                        return;
                    } else {
                        guessId = alias[guessId][0].id.toString();
                        guessData = musicInfo[guessId];
                        if (!guessData) {
                            document.getElementById("message").innerText = "æ›²ç›®ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚";
                            return;
                        }
                    }
                } else {
                    document.getElementById("message").innerText = "æ›²ç›®ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚";
                    return;
                }
            }

            if (guessedIds.includes(guessId)) {
                document.getElementById("message").innerText = "ä½ å·²ç»çŒœè¿‡è¿™ä¸ªæ›²ç›®äº†ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚";
                return;
            }

            guessedIds.push(guessId);
            guesses.push(`ID: ${guessId}, æ ‡é¢˜: ${guessData.title}`);
            const hints = getHint(targetMusic, guessData);
            hintsList.push(hints);

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById("guess-id").value = "";

            if (targetMusic.title === guessData.title) {
                isPlaying = false;
                document.getElementById("message").innerText = "ğŸ‰ æ­å–œä½ ï¼ŒçŒœå¯¹äº†ï¼ğŸ‰";
                renderHints();
                return;
            }

            if (guesses.length >= 10) {
                isPlaying = false;
                document.getElementById("message").innerText = `ä½ å·²ç»çŒœé”™10æ¬¡ï¼Œæ¸¸æˆç»“æŸï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ ${targetMusic.id}ï¼š${targetMusic.title}`;
                renderHints();
                return;
            }

            document.getElementById("message").innerText = "ç»§ç»­çŒœæµ‹ï¼";
            renderHints();
        }

        function quitGame() {
            if (!isPlaying) {
                document.getElementById("message").innerText = "å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„æ¸¸æˆã€‚";
                return;
            }
            isPlaying = false;
            document.getElementById("message").innerText = `æ¸¸æˆç»“æŸï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${targetMusic.id}ï¼š${targetMusic.title}`;
        }

        function renderHints() {
            const hintsContainer = document.getElementById("hints-container");
            hintsContainer.innerHTML = "";
            hintsList.forEach((hintSet, index) => {
                const guessBlock = document.createElement("div");
                guessBlock.style.display = "flex";
                guessBlock.style.flexDirection = "column";
                guessBlock.style.marginBottom = "20px";

                // ä¸Šæ–¹éƒ¨åˆ†ï¼šå·¦ä¾§ï¼ˆçŒœæµ‹æ ‡é¢˜å’Œç¬¬ä¸€æ¡æç¤ºï¼‰å’Œå³ä¾§ï¼ˆæ›²ç»˜ï¼‰
                const topBlock = document.createElement("div");
                topBlock.style.display = "flex";
                topBlock.style.alignItems = "flex-start";

                // å·¦ä¾§éƒ¨åˆ†ï¼šçŒœæµ‹æ ‡é¢˜å’Œç¬¬ä¸€æ¡æç¤º
                const leftBlock = document.createElement("div");
                leftBlock.style.display = "flex";
                leftBlock.style.flexDirection = "column";

                const guessTitle = document.createElement("strong");
                guessTitle.textContent = `çŒœæµ‹ ${index + 1}:`;
                guessTitle.style.margin = "8px 0 5px 0";
                leftBlock.appendChild(guessTitle);

                [0, 1].forEach(i => {
                    const hint = document.createElement("p");
                    hint.style.color = hintSet[i].includes("âˆš") ? "green" : hintSet[i].includes("â†•") ? "orange" : "grey";
                    hint.style.margin = "14px 0 0 0"; 
                    hint.textContent = hintSet[i].replace("âˆš", "").replace("â†•", "");
                    leftBlock.appendChild(hint);
                });

                // å³ä¾§éƒ¨åˆ†ï¼šæ›²ç»˜
                const jacketImg = document.createElement("img");
                const guessId = guessedIds[index];
                const jacketId = guessId % 10000; // è®¡ç®—æ›²ç»˜ ID
                jacketImg.src = `https://assets2.lxns.net/maimai/jacket/${jacketId}.png`;
                jacketImg.alt = "æ›²ç»˜";
                jacketImg.style.width = "80px";
                jacketImg.style.height = "80px";
                jacketImg.style.marginLeft = "10px";

                // å°†å·¦ä¾§å’Œå³ä¾§éƒ¨åˆ†ç»„åˆåˆ°ä¸Šæ–¹éƒ¨åˆ†
                topBlock.appendChild(leftBlock);
                topBlock.appendChild(jacketImg);

                // ä¸‹æ–¹éƒ¨åˆ†ï¼šå‰©ä½™çš„æç¤ºå†…å®¹
                const bottomBlock = document.createElement("div");
                hintSet.slice(2).forEach(hint => {
                    const hintLine = document.createElement("p");
                    hintLine.style.color = hint.includes("âˆš") ? "green" : hint.includes("â†•") ? "orange" : "grey";
                    hintLine.textContent = hint.replace("âˆš", "").replace("â†•", "");
                    bottomBlock.appendChild(hintLine);
                });

                // å°†ä¸Šæ–¹éƒ¨åˆ†å’Œä¸‹æ–¹éƒ¨åˆ†ç»„åˆåˆ°æ•´ä¸ªå—
                guessBlock.appendChild(topBlock);
                guessBlock.appendChild(bottomBlock);

                hintsContainer.appendChild(guessBlock);
            });
        }

        window.onload = async () => {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const loadingDiv = document.getElementById("loading");
            const gameContainer = document.getElementById("game-container");

            try {
                await loadGameData(); // åŠ è½½æ¸¸æˆæ•°æ®
                loadingDiv.style.display = "none"; // éšè—åŠ è½½æç¤º
                gameContainer.style.display = "block"; // æ˜¾ç¤ºæ¸¸æˆå†…å®¹
            } catch (error) {
                loadingDiv.textContent = "åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼";
                console.error("åŠ è½½æ¸¸æˆæ•°æ®æ—¶å‡ºé”™ï¼š", error);
            }

            document.getElementById("start-game").addEventListener("click", startGame);
            document.getElementById("submit-guess").addEventListener("click", submitGuess);
            document.getElementById("quit-game").addEventListener("click", quitGame);
        };
    </script>
</head>
<body>
    <!-- åŠ è½½æç¤º -->
    <div id="loading" style="font-size: 20px; text-align: center; margin-top: 50px;">
        åŠ è½½æ•°æ®ä¸­ï¼Œè¯·ç¨å€™...
        <div style="margin-top: 20px; width: 80%; margin-left: auto; margin-right: auto; background-color: #f3f3f3; border-radius: 5px; height: 20px; overflow: hidden;">
            <div id="progress-bar" style="width: 0%; height: 100%; background-color: #4caf50; transition: width 0.3s;"></div>
        </div>
        <p id="progress-text" style="margin-top: 10px;">0%</p>
    </div>

    <!-- æ¸¸æˆå†…å®¹ -->
    <div id="game-container" style="display: none;">
        <h1>Maidle æ¸¸æˆ</h1>
        <p>made by å®‡èˆªå‘˜Dale</p>
        <div id="hints-container" style="margin-top: 20px; font-size: 16px; line-height: 0.7;"></div>
        <div>
            <input type="text" id="guess-id" placeholder="è¾“å…¥æ›²ç›®idæˆ–åˆ«å" style="font-size: 18px; padding: 10px; width: 60%;" oninput="searchMatches()">
            <div id="search-results" style="position: absolute; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; width: 60%;"></div>
        </div>
        <div>
            <p>æç¤ºï¼šå¯ä»¥è¾“å…¥æ›²ç›®idæˆ–åˆ«åã€‚ç»¿è‰²ä»£è¡¨æ­£ç¡®ï¼Œå®šæ•°é»„è‰²ä»£è¡¨ç­‰çº§æ­£ç¡®ã€‚</p>
        </div>
        <div style="margin-top: 5px; margin-bottom: 15px;">
            <label for="difficulty-range" style="font-size: 18px;">é€‰æ‹©å‡ºé¢˜èŒƒå›´ï¼š</label>
            <select id="difficulty-range" style="font-size: 18px; padding: 5px 5px;">
                <option value="unlimited">æ— é™åˆ¶</option>
                <option value="13">ç´«è°±ç­‰çº§13åŠä»¥ä¸Š</option>
                <option value="13+">ç´«è°±ç­‰çº§13+åŠä»¥ä¸Š</option>
                <option value="14">ç´«è°±ç­‰çº§14åŠä»¥ä¸Š</option>
                <option value="14+">ç´«è°±ç­‰çº§14+åŠä»¥ä¸Š</option>
            </select>
        </div>
        <div>
            <button id="start-game" style="font-size: 18px; padding: 10px 20px;">å¼€å§‹æ¸¸æˆ</button>
            <button id="submit-guess" style="font-size: 18px; padding: 10px 20px;">æäº¤çŒœæµ‹</button>
            <button id="quit-game" style="font-size: 18px; padding: 10px 20px;">ä¸ç©äº†</button>
        </div>
        <p id="message"></p>
        <p>æœ¬ç«™æ€»è®¿é—®é‡ï¼š<span id="busuanzi_value_site_pv"></span> æ¬¡</p>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    </div>
</body>
</html>